version: '3.8'

# Required ports for FNAL controls network:
# =========================================
# EPICS Channel Access (CA):
#   - 5064/udp, 5064/tcp  : CA server port
#   - 5065/udp            : CA repeater port
#   - 6710-6740/udp       : Custom CA ports (per settings.ini address list)
#
# EPICS PVAccess (PVA):
#   - 5075/udp            : PVA broadcast/search port
#   - 5076/tcp            : PVA server port (default)
#
# Backend Services:
#   - 9092/tcp   : Kafka (alarm server at acsys-services.fnal.gov)
#   - 17668/tcp  : Archiver (archiver1.fnal.gov)
#   - 443/tcp    : HTTPS services (ad-services.fnal.gov - ChannelFinder, Save/Restore, Alarm Logger)
#
# Multicast (if needed):
#   - 239.128.1.6 : EPICS CA multicast group
#
# =========================================
# SSH TUNNEL SETUP (for remote access)
# =========================================
# Since SSH only forwards TCP (not UDP), you'll need to set up tunnels
# for the TCP-based services. For EPICS CA/PVA, use a CA Gateway or 
# configure explicit IOC addresses.
#
# Example SSH tunnel command (run on your local machine BEFORE docker-compose up):
#
#   ssh -L 9092:acsys-services.fnal.gov:9092 \
#       -L 17668:archiver1.fnal.gov:17668 \
#       -L 5064:localhost:5064 \
#       -L 5076:localhost:5076 \
#       -N <gateway-host>
#
# For full EPICS CA access through SSH, consider running a CA Gateway
# on the controls network side, or use socat to tunnel UDP over SSH.
#
# =========================================
# In order to run you need to set the xhost in your host machine
# Allow X11 access (run once)
#   xhost +local:docker


services:
  phoebus:
    image: phoebus-fnal:latest
    container_name: phoebus-fnal
    # X11 forwarding for GUI display
    environment:
      - DISPLAY=${DISPLAY}
      # =============================================
      # EPICS CA config for SSH tunnel setup
      # =============================================
      # Disable auto address list (no broadcasts over SSH)
      - EPICS_CA_AUTO_ADDR_LIST=NO
      # Point to localhost where SSH tunnel terminates (or gateway IP)
      - EPICS_CA_ADDR_LIST=localhost
      - EPICS_CA_SERVER_PORT=5064
      - EPICS_CA_REPEATER_PORT=5065
      # =============================================
      # EPICS PVA config for SSH tunnel setup
      # =============================================
      - EPICS_PVA_AUTO_ADDR_LIST=NO
      - EPICS_PVA_ADDR_LIST=localhost
      - EPICS_PVA_BROADCAST_PORT=5075
      - EPICS_PVA_SERVER_PORT=5076
    volumes:
      # X11 socket for display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Optional: Mount local config directory for custom settings
      - ./config:/opt/phoebus/config:ro
      # Optional: Mount a directory for user data persistence
      - phoebus-data:/home/phoebus
    # Use host network to access SSH tunnels on localhost
    network_mode: host
    # For better X11 compatibility
    ipc: host
    # Security options for X11
    security_opt:
      - seccomp:unconfined

volumes:
  phoebus-data:
